---
import ReaderLayout from '../../layouts/ReaderLayout.astro';
import type { MarkdownInstance } from 'astro';
import fs from 'node:fs';
import { marked } from 'marked';

interface Frontmatter {
  document_title?: string;
  page_number?: number;
  [key: string]: any;
}

export async function getStaticPaths() {
  // Récupère tous les fichiers markdown dans output_2
  const allPages = await Astro.glob<Frontmatter>('../output_2/**/*.md');
  
  // Regroupe les pages par dossier (ID du document)
  const pagesByDoc: Record<string, MarkdownInstance<Frontmatter>[]> = {};
  
  allPages.forEach((page) => {
    // Le chemin du fichier est dans page.file
    // Exemple: .../src/pages/output_2/23248.Zeendoc/page_1.md
    // Gestion des séparateurs de chemin Windows/Unix
    const parts = page.file.split(/[/\\]/);
    // On suppose que la structure est .../output_2/[dossier]/[fichier]
    // On cherche l'index de output_2 pour trouver le dossier suivant
    const outputIndex = parts.indexOf('output_2');
    if (outputIndex !== -1 && parts.length > outputIndex + 1) {
      const docId = parts[outputIndex + 1];
      
      if (!pagesByDoc[docId]) {
        pagesByDoc[docId] = [];
      }
      pagesByDoc[docId].push(page);
    }
  });

  // Crée les chemins pour chaque document
  return Object.keys(pagesByDoc).map((docId) => {
    // Trie les pages par numéro de page (supposant que le frontmatter a page_number ou le nom de fichier)
    const sortedPages = pagesByDoc[docId].sort((a, b) => {
      const pageA = a.frontmatter.page_number || parseInt(a.file.match(/page_(\d+)/)?.[1] || "0");
      const pageB = b.frontmatter.page_number || parseInt(b.file.match(/page_(\d+)/)?.[1] || "0");
      return pageA - pageB;
    });

    return {
      params: { id: docId },
      props: { pages: sortedPages, docId },
    };
  });
}

interface Props {
  pages: MarkdownInstance<Frontmatter>[];
  docId: string;
}

const { pages, docId } = Astro.props;
const title = pages[0]?.frontmatter?.document_title || docId;

// Fusion du contenu
let fullMarkdown = "";
// Contenu paginé pour le mobile
const pagesContent: string[] = [];

pages.forEach((page, index) => {
  try {
    // Lecture du fichier brut
    const content = fs.readFileSync(page.file, 'utf-8');
    
    // Suppression du frontmatter (entre les deux premiers ---)
    // On cherche la fin du frontmatter
    const parts = content.split('---');
    let rawBody = "";
    if (parts.length >= 3) {
      // Le contenu est tout ce qui suit le 2ème ---
      rawBody = parts.slice(2).join('---').trim();
    } else {
      rawBody = content; // Pas de frontmatter ?
    }

    // --- Logique pour la version Desktop (Fusionnée) ---
    // Gestion de la fusion avec la page précédente
    if (fullMarkdown.length > 0) {
      // Vérifie si la fin du texte précédent est un tiret (césure)
      if (fullMarkdown.trim().endsWith('-')) {
        // On supprime le tiret final et on colle le nouveau texte
        fullMarkdown = fullMarkdown.trim().slice(0, -1) + rawBody;
      } else {
        // Sinon on ajoute un espace/saut de ligne standard
        fullMarkdown += "\n\n" + rawBody;
      }
    } else {
      fullMarkdown = rawBody;
    }

    // --- Logique pour la version Mobile (Paginée) ---
    // On nettoie juste un peu le contenu individuel
    let pageBody = rawBody;
    // Correction des chemins d'images pour cette page
    pageBody = pageBody.replace(/\]\(images\//g, `](/images/${docId}/`);
    pageBody = pageBody.replace(/src="images\//g, `src="/images/${docId}/`);
    
    pagesContent.push(marked.parse(pageBody, { breaks: true }) as string);

  } catch (e) {
    console.error(`Erreur lecture fichier ${page.file}`, e);
  }
});

// Correction des chemins d'images (Desktop)
// Remplace "images/nom_image.jpg" par "/images/DOC_ID/nom_image.jpg"
fullMarkdown = fullMarkdown.replace(/\]\(images\//g, `](/images/${docId}/`);
fullMarkdown = fullMarkdown.replace(/src="images\//g, `src="/images/${docId}/`);

// Conversion en HTML (Desktop)
const contentHtml = marked.parse(fullMarkdown, { breaks: true });
---

<ReaderLayout frontmatter={{ title: title }}>
  <!-- Version Desktop (Scroll Vertical Continu) -->
  <div class="document-container desktop-view" id="doc-container">
    <h1 class="document-title">{title}</h1>
    
    <div class="pages-list">
      <div class="page-container">
        <div class="page-content" id="content-area" set:html={contentHtml} />
      </div>
    </div>
  </div>

  <!-- Version Mobile (Slider Horizontal) -->
  <div class="mobile-view" id="mobile-reader">
    <div class="mobile-slider" id="mobile-slider">
      {pagesContent.map((html, index) => (
        <div class="mobile-page">
          <div class="mobile-page-content page-content" set:html={html} />
          <div class="mobile-page-number">{index + 1} / {pagesContent.length}</div>
        </div>
      ))}
    </div>
  </div>

  <!-- Barre d'outils flottante -->
  <button id="settings-toggle" class="settings-toggle" title="Paramètres d'affichage">
    Aa
  </button>

  <div id="settings-bar" class="settings-bar">
    <!-- Onglets -->
    <div class="settings-tabs">
      <button class="tab-btn active" data-tab="text">Texte</button>
      <button class="tab-btn" data-tab="theme">Thème</button>
    </div>

    <!-- Contenu Onglet Texte -->
    <div id="tab-text" class="tab-content active">
      <!-- Police -->
      <div class="setting-row font-family-row">
        <button class="font-btn active" data-font="Helvetica" style="font-family: Helvetica;">Sans</button>
        <button class="font-btn" data-font="Georgia" style="font-family: Georgia;">Serif</button>
        <button class="font-btn" data-font="OpenDyslexic" style="font-family: OpenDyslexic;">Dys</button>
      </div>

      <!-- Taille -->
      <div class="setting-row size-row">
        <button id="font-decrease" class="control-btn">T-</button>
        <span id="font-size-display">100%</span>
        <button id="font-increase" class="control-btn">T+</button>
      </div>

      <!-- Espacement -->
      <div class="setting-row spacing-row">
        <button class="control-btn spacing-btn" data-spacing="1.2" title="Compact">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <button class="control-btn spacing-btn active" data-spacing="1.6" title="Normal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 5h16M4 12h16M4 19h16"/></svg>
        </button>
        <button class="control-btn spacing-btn" data-spacing="2.0" title="Large">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16M4 12h16M4 20h16"/></svg>
        </button>
      </div>
    </div>

    <!-- Contenu Onglet Thème -->
    <div id="tab-theme" class="tab-content">
      <div class="theme-selector">
        <button class="theme-btn theme-light" data-theme="theme-light" title="Clair">A</button>
        <button class="theme-btn theme-sepia" data-theme="theme-sepia" title="Sépia">A</button>
        <button class="theme-btn theme-dark" data-theme="theme-dark" title="Sombre">A</button>
      </div>
    </div>
  </div>

  <!-- Contrôle de Zoom Flottant (Supprimé) -->
  <!-- <div class="zoom-widget">...</div> -->

  <!-- Barre de progression de lecture -->
  <div class="reading-progress-container">
    <div id="reading-progress-bar" class="reading-progress-bar"></div>
  </div>
</ReaderLayout>

<script>
  const params = new URLSearchParams(window.location.search);
  const docContainer = document.getElementById('doc-container');
  const mobileReader = document.getElementById('mobile-reader');
  // const dyslexiaToggle = document.getElementById('dyslexia-toggle-reader') as HTMLInputElement; // Supprimé car géré dans les onglets maintenant

  // Initialisation du mode dyslexie via URL (Legacy support)
  if (params.get('dyslexia') === 'true') {
    docContainer?.classList.add('dyslexia');
    mobileReader?.classList.add('dyslexia');
    // if (dyslexiaToggle) dyslexiaToggle.checked = true;
  }

  /*
  // Gestion du toggle dyslexie dans la barre (Ancien code)
  dyslexiaToggle?.addEventListener('change', (e) => {
    if ((e.target as HTMLInputElement).checked) {
      docContainer?.classList.add('dyslexia');
      mobileReader?.classList.add('dyslexia');
    } else {
      docContainer?.classList.remove('dyslexia');
      mobileReader?.classList.remove('dyslexia');
    }
  });
  */

  // Gestion de la barre de paramètres
  const toggleBtn = document.getElementById('settings-toggle');
  const settingsBar = document.getElementById('settings-bar');
  const contentAreas = document.querySelectorAll('.page-content');
  const pagesList = document.querySelector('.pages-list') as HTMLElement;
  const themeBtns = document.querySelectorAll('.theme-btn');

  // Onglets
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // Reset active states
      tabBtns.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      
      // Set active
      btn.classList.add('active');
      const tabId = btn.getAttribute('data-tab');
      document.getElementById(`tab-${tabId}`)?.classList.add('active');
    });
  });

  // Police
  const fontBtns = document.querySelectorAll('.font-btn');
  fontBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      fontBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const font = btn.getAttribute('data-font');
      contentAreas.forEach(area => {
        (area as HTMLElement).style.fontFamily = font || 'inherit';
      });
    });
  });

  // Taille (Zoom)
  let currentZoom = 100; // Pourcentage
  const fontDecreaseBtn = document.getElementById('font-decrease');
  const fontIncreaseBtn = document.getElementById('font-increase');
  const fontSizeDisplay = document.getElementById('font-size-display');

  function updateZoom(newZoom: number) {
    currentZoom = Math.max(50, Math.min(200, newZoom)); // Limites 50% - 200%
    const scale = currentZoom / 100;
    
    // Mise à jour affichage
    if (fontSizeDisplay) fontSizeDisplay.textContent = `${currentZoom}%`;
    
    // Application du zoom Desktop
    if (pagesList) {
      // @ts-ignore
      pagesList.style.zoom = scale;
      
      // Fallback Firefox
      if (getComputedStyle(pagesList).zoom === '1' && scale !== 1) {
        pagesList.style.transform = `scale(${scale})`;
        pagesList.style.transformOrigin = 'top center';
      }
    }

    // Application du zoom Mobile
    const mobilePages = document.querySelectorAll('.mobile-page-content');
    mobilePages.forEach(page => {
      const p = page as HTMLElement;
      // @ts-ignore
      p.style.zoom = scale;
      
      // Fallback Firefox
      if (getComputedStyle(p).zoom === '1' && scale !== 1) {
        p.style.transform = `scale(${scale})`;
        p.style.transformOrigin = 'top left';
      }
    });
  }

  fontDecreaseBtn?.addEventListener('click', () => updateZoom(currentZoom - 10));
  fontIncreaseBtn?.addEventListener('click', () => updateZoom(currentZoom + 10));

  // Espacement
  const spacingBtns = document.querySelectorAll('.spacing-btn');
  spacingBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      spacingBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const spacing = btn.getAttribute('data-spacing');
      contentAreas.forEach(area => {
        (area as HTMLElement).style.lineHeight = spacing || '1.6';
      });
    });
  });

  toggleBtn?.addEventListener('click', () => {
    settingsBar?.classList.toggle('visible');
  });

  // Gestion des thèmes
  themeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const theme = btn.getAttribute('data-theme');
      // Retire toutes les classes de thème
      document.documentElement.classList.remove('theme-light', 'theme-sepia', 'theme-dark');
      // Ajoute la nouvelle si ce n'est pas le défaut (ou on peut tout gérer via classes)
      if (theme) {
        document.documentElement.classList.add(theme);
      }
      
      // Mise à jour visuelle des boutons
      themeBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // Fermer si on clique ailleurs
  document.addEventListener('click', (e) => {
    if (!settingsBar?.contains(e.target as Node) && !toggleBtn?.contains(e.target as Node)) {
      settingsBar?.classList.remove('visible');
    }
  });



  // Gestion de la barre de progression
  const progressBar = document.getElementById('reading-progress-bar');
  const mobileSlider = document.getElementById('mobile-slider');
  
  // Scroll Desktop
  window.addEventListener('scroll', () => {
    if (window.innerWidth <= 768) return; // Ignorer sur mobile
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrollPercent = (scrollTop / docHeight) * 100;
    
    if (progressBar) {
      progressBar.style.width = `${scrollPercent}%`;
    }
  });

  // Scroll Mobile
  mobileSlider?.addEventListener('scroll', () => {
    const scrollLeft = mobileSlider.scrollLeft;
    const scrollWidth = mobileSlider.scrollWidth - mobileSlider.clientWidth;
    const scrollPercent = (scrollLeft / scrollWidth) * 100;
    
    if (progressBar) {
      progressBar.style.width = `${scrollPercent}%`;
    }
  });
</script>

<style>
  /* Styles de la barre d'outils */
  .settings-toggle {
    position: fixed;
    bottom: 6rem;
    right: 2rem; /* Déplacé à gauche */
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--accent-color);
    color: white;
    border: none;
    font-family: serif;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 100;
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .settings-toggle:hover {
    transform: scale(1.1);
  }

  /* Styles du Zoom Flottant (Supprimé) */
  /* .zoom-widget { ... } */

  .settings-bar {
    position: fixed;
    bottom: 10rem;
    right: 2rem;
    width: 320px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    transform: translateY(20px);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 99;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 0;
  }

  .settings-bar.visible {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  /* Onglets */
  .settings-tabs {
    display: flex;
    border-bottom: 1px solid #eee;
  }

  .tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    font-weight: bold;
    color: #999;
    cursor: pointer;
    position: relative;
    transition: color 0.2s;
  }

  .tab-btn.active {
    color: var(--accent-color);
  }

  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--accent-color);
  }

  .tab-content {
    display: none;
    padding: 1.5rem;
  }

  .tab-content.active {
    display: block;
  }

  /* Lignes de paramètres */
  .setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    gap: 1rem;
  }

  .setting-row:last-child {
    margin-bottom: 0;
  }

  /* Boutons de police */
  .font-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 1px solid #ddd;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.2rem;
    color: #333;
    transition: all 0.2s;
  }

  .font-btn.active {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background: rgba(140, 94, 88, 0.05);
    box-shadow: 0 0 0 2px rgba(140, 94, 88, 0.2);
  }

  /* Contrôles Taille & Espacement */
  .control-btn {
    flex: 1;
    height: 48px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .control-btn:hover {
    background: #f5f5f5;
  }

  .control-btn.active {
    background: #eee;
    border-color: #ccc;
  }

  #font-size-display {
    font-weight: bold;
    min-width: 60px;
    text-align: center;
  }

  .theme-selector {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    padding: 0.5rem;
  }

  .theme-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid #e0e0e0;
    cursor: pointer;
    font-family: serif;
    font-weight: bold;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    position: relative;
  }

  .theme-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .theme-btn.active {
    border-color: var(--accent-color);
    transform: scale(1.1);
    box-shadow: 0 0 0 3px rgba(140, 94, 88, 0.3);
  }

  /* Indicateur visuel pour le thème actif */
  .theme-btn.active::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background-color: var(--accent-color);
    border-radius: 50%;
  }

  .theme-btn.theme-light { background: #ffffff; color: #333; }
  .theme-btn.theme-sepia { background: #f4ecd8; color: #5b4636; border-color: #e3dcc8; }
  .theme-btn.theme-dark { background: #1a1a1a; color: #e0e0e0; border-color: #333; }

  .document-container {
    font-family: Helvetica;
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem 0;
  }

  /* Mobile View Styles */
  .mobile-view {
    display: none;
  }

  @media (max-width: 768px) {
    .desktop-view {
      display: none;
    }

    .mobile-view {
      display: block;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .mobile-slider {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      height: 100%;
      width: 100%;
      /* Hide scrollbar */
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .mobile-slider::-webkit-scrollbar {
      display: none;
    }

    .mobile-page {
      flex: 0 0 100%;
      scroll-snap-align: start;
      overflow-y: auto;
      padding: 4rem 1.5rem 6rem 1.5rem; /* Espace pour header/footer */
      box-sizing: border-box;
      height: 100%;
      position: relative;
    }

    .mobile-page-number {
      position: absolute;
      bottom: 4rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      opacity: 0.5;
    }

    /* Ajustements UI Mobile */
    .settings-toggle {
      bottom: 8rem;
    }
    
    /* .zoom-widget { ... } Supprimé */
  }

  .dyslexia {
    font-family: 'OpenDyslexic', sans-serif;
  }

  .document-title {
    text-align: center;
    margin-bottom: 3rem;
    color: var(--accent-color);
  }

  .pages-list {
    border-radius: 4px;
    overflow: hidden;
  }

  .page-container {
    margin-bottom: 0;
    padding: 3rem;
    border-bottom: 1px dashed rgba(0,0,0,0.1); /* Séparateur discret pour marquer la fin de page */
  }

  .page-container:last-child {
    border-bottom: none;
  }

  .page-header {
    font-size: 0.8rem;
    color: #999;
    text-transform: uppercase;
    margin-bottom: 1rem;
    text-align: right;
  }

  .page-content {
    font-size: 1rem;
    line-height: 1.6;
  }
  .page-separator {
    border: 0;
    height: 1px;
    background: #e0e0e0;
    margin-top: 3rem;
    display: none; /* Caché car on a des boites séparées */
  }

  /* Barre de progression */
  .reading-progress-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: rgba(0,0,0,0.05);
    z-index: 200;
  }

  .reading-progress-bar {
    height: 100%;
    background: var(--accent-color);
    width: 0%;
    transition: width 0.1s;
    border-top-right-radius: 3px;
    border-bottom-right-radius: 3px;
  }
</style>
